<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OpenClaw Agent ç›£æ§é¢æ¿</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Inter', sans-serif; }
    .gradient-bg { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); }
    .card { background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
    .status-dot { animation: pulse 2s infinite; }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .scrollbar-thin::-webkit-scrollbar { width: 6px; height: 6px; }
    .scrollbar-thin::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }
    .scrollbar-thin::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }
  </style>
</head>
<body class="gradient-bg min-h-screen text-white">
  <!-- Header -->
  <header class="border-b border-white/10 px-6 py-4">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-4">
        <div class="w-10 h-10 bg-blue-500 rounded-lg flex items-center justify-center text-xl">ğŸ¦·</div>
        <div>
          <h1 class="text-xl font-bold">OpenClaw Agent ç›£æ§é¢æ¿</h1>
          <p class="text-sm text-gray-400">Agent åœ˜éšŠç®¡ç†å„€è¡¨æ¿</p>
        </div>
      </div>
      <div class="flex items-center gap-4">
        <div class="flex items-center gap-2">
          <span id="connectionStatus" class="w-2 h-2 bg-green-400 rounded-full status-dot"></span>
          <span class="text-sm text-gray-400">å·²é€£ç·š</span>
        </div>
        <button onclick="openAgentTeamModal()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg text-sm font-medium transition">
          + æ–°å»º Agent åœ˜éšŠ
        </button>
      </div>
    </div>
  </header>

  <!-- Stats Cards -->
  <div class="px-6 py-6">
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
      <div class="card rounded-xl p-5">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-gray-400 text-sm">ä½œç”¨ä¸­çš„å·¥ä½œéšæ®µ</p>
            <p id="statActiveSessions" class="text-3xl font-bold mt-1">0</p>
          </div>
          <div class="w-12 h-12 bg-blue-500/20 rounded-lg flex items-center justify-center text-2xl">ğŸ”µ</div>
        </div>
      </div>
      <div class="card rounded-xl p-5">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-gray-400 text-sm">åŸ·è¡Œä¸­çš„ä»»å‹™</p>
            <p id="statRunningTasks" class="text-3xl font-bold mt-1 text-yellow-400">0</p>
          </div>
          <div class="w-12 h-12 bg-yellow-500/20 rounded-lg flex items-center justify-center text-2xl">âš¡</div>
        </div>
      </div>
      <div class="card rounded-xl p-5">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-gray-400 text-sm">å·²å®Œæˆä»»å‹™</p>
            <p id="statCompleted" class="text-3xl font-bold mt-1 text-green-400">0</p>
          </div>
          <div class="w-12 h-12 bg-green-500/20 rounded-lg flex items-center justify-center text-2xl">âœ…</div>
        </div>
      </div>
      <div class="card rounded-xl p-5">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-gray-400 text-sm">ç¸½å ±å‘Šæ•¸</p>
            <p id="statReports" class="text-3xl font-bold mt-1 text-purple-400">0</p>
          </div>
          <div class="w-12 h-12 bg-purple-500/20 rounded-lg flex items-center justify-center text-2xl">ğŸ“Š</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="px-6 pb-6">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Agent Sessions -->
      <div class="lg:col-span-2 card rounded-xl">
        <div class="p-4 border-b border-white/10">
          <h2 class="font-semibold">ä½œç”¨ä¸­çš„ Agents</h2>
        </div>
        <div id="agentsList" class="p-4 space-y-3 max-h-96 overflow-y-auto scrollbar-thin">
          <p class="text-gray-500 text-center py-8">ç›®å‰æ²’æœ‰ä½œç”¨ä¸­çš„ Agents</p>
        </div>
      </div>

      <!-- Task Queue -->
      <div class="card rounded-xl">
        <div class="p-4 border-b border-white/10">
          <h2 class="font-semibold">ä»»å‹™ä½‡åˆ—</h2>
        </div>
        <div id="taskQueue" class="p-4 space-y-3 max-h-96 overflow-y-auto scrollbar-thin">
          <p class="text-gray-500 text-center py-8">ç›®å‰æ²’æœ‰å¾…è™•ç†çš„ä»»å‹™</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Report Section -->
  <div class="px-6 pb-6">
    <div class="card rounded-xl">
      <div class="p-4 border-b border-white/10 flex items-center justify-between">
        <h2 class="font-semibold text-lg">ğŸ“‹ å®Œæˆå ±å‘Š</h2>
        <div class="flex gap-2">
          <select id="reportFilter" class="bg-white/10 border border-white/20 rounded-lg px-3 py-1 text-sm">
            <option value="all">å…¨éƒ¨å ±å‘Š</option>
            <option value="today">ä»Šå¤©</option>
            <option value="week">æœ¬é€±</option>
          </select>
        </div>
      </div>
      <div id="reportsList" class="p-4 space-y-4 max-h-[500px] overflow-y-auto scrollbar-thin">
        <p class="text-gray-500 text-center py-8">ç›®å‰æ²’æœ‰å®Œæˆå ±å‘Š</p>
      </div>
    </div>
  </div>

  <!-- Agent Team Modal -->
  <div id="agentTeamModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50">
    <div class="card rounded-xl w-full max-w-2xl mx-4 max-h-[90vh] overflow-hidden">
      <div class="p-4 border-b border-white/10 flex items-center justify-between">
        <h3 class="font-semibold text-lg">å»ºç«‹ Agent åœ˜éšŠä»»å‹™</h3>
        <button onclick="closeAgentTeamModal()" class="text-gray-400 hover:text-white">âœ•</button>
      </div>
      <div class="p-4 overflow-y-auto max-h-[70vh]">
        <div class="space-y-4">
          <div>
            <label class="block text-sm text-gray-400 mb-2">ä»»å‹™æè¿°</label>
            <textarea id="taskDescription" class="w-full bg-white/5 border border-white/20 rounded-lg p-3 text-white h-24" placeholder="æè¿°æ‚¨å¸Œæœ› Agent åœ˜éšŠåŸ·è¡Œçš„ä»»å‹™..."></textarea>
          </div>
          <div>
            <label class="block text-sm text-gray-400 mb-2">é¸æ“‡ Agents</label>
            <div id="agentSelection" class="grid grid-cols-2 gap-2">
              <label class="flex items-center gap-2 p-2 bg-white/5 rounded-lg cursor-pointer hover:bg-white/10">
                <input type="checkbox" value="coder" checked class="accent-blue-500">
                <span>ğŸ’» ç¨‹å¼ç¢¼ Agent</span>
              </label>
              <label class="flex items-center gap-2 p-2 bg-white/5 rounded-lg cursor-pointer hover:bg-white/10">
                <input type="checkbox" value="researcher" checked class="accent-blue-500">
                <span>ğŸ” ç ”ç©¶ Agent</span>
              </label>
              <label class="flex items-center gap-2 p-2 bg-white/5 rounded-lg cursor-pointer hover:bg-white/10">
                <input type="checkbox" value="tester" checked class="accent-blue-500">
                <span>ğŸ§ª æ¸¬è©¦ Agent</span>
              </label>
              <label class="flex items-center gap-2 p-2 bg-white/5 rounded-lg cursor-pointer hover:bg-white/10">
                <input type="checkbox" value="deployer" class="accent-blue-500">
                <span>ğŸš€ éƒ¨ç½² Agent</span>
              </label>
            </div>
          </div>
          <div>
            <label class="block text-sm text-gray-400 mb-2">å·¥ä½œæµç¨‹æ­¥é©Ÿ</label>
            <div id="workflowSteps" class="space-y-2">
              <div class="flex gap-2">
                <input type="text" value="1. åˆ†æéœ€æ±‚" class="flex-1 bg-white/5 border border-white/20 rounded-lg px-3 py-2 text-sm" readonly>
              </div>
              <div class="flex gap-2">
                <input type="text" value="2. å¯¦ä½œè§£æ±ºæ–¹æ¡ˆ" class="flex-1 bg-white/5 border border-white/20 rounded-lg px-3 py-2 text-sm" readonly>
              </div>
              <div class="flex gap-2">
                <input type="text" value="3. åŸ·è¡Œæ¸¬è©¦" class="flex-1 bg-white/5 border border-white/20 rounded-lg px-3 py-2 text-sm" readonly>
              </div>
              <div class="flex gap-2">
                <input type="text" value="4. ç”Ÿæˆå ±å‘Š" class="flex-1 bg-white/5 border border-white/20 rounded-lg px-3 py-2 text-sm" readonly>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="p-4 border-t border-white/10 flex justify-end gap-3">
        <button onclick="closeAgentTeamModal()" class="px-4 py-2 text-gray-400 hover:text-white">å–æ¶ˆ</button>
        <button onclick="submitAgentTeam()" class="bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded-lg font-medium">åŸ·è¡Œåœ˜éšŠä»»å‹™</button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = '';
    let ws = null;
    let stats = {};
    let sessions = [];
    let tasks = [];
    let reports = [];

    // WebSocket connection
    function connectWebSocket() {
      ws = new WebSocket(`ws://${window.location.host}`);
      
      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        handleMessage(data);
      };
      
      ws.onclose = () => {
        document.getElementById('connectionStatus').classList.remove('bg-green-400');
        document.getElementById('connectionStatus').classList.add('bg-red-400');
        setTimeout(connectWebSocket, 3000);
      };
      
      ws.onopen = () => {
        document.getElementById('connectionStatus').classList.remove('bg-red-400');
        document.getElementById('connectionStatus').classList.add('bg-green-400');
      };
    }

    function handleMessage(data) {
      switch(data.type) {
        case 'agentUpdate':
          refreshData();
          break;
        case 'taskUpdate':
          refreshTasks();
          break;
        case 'taskComplete':
          refreshReports();
          break;
      }
    }

    async function refreshData() {
      try {
        const [statsRes, sessionsRes] = await Promise.all([
          fetch(`${API_BASE}/api/stats`),
          fetch(`${API_BASE}/api/sessions`)
        ]);
        
        stats = await statsRes.json();
        sessions = await sessionsRes.json();
        
        updateStats();
        updateAgentsList();
      } catch (e) {
        console.error('Error refreshing data:', e);
      }
    }

    async function refreshTasks() {
      try {
        const res = await fetch(`${API_BASE}/api/tasks`);
        tasks = await res.json();
        updateTaskQueue();
      } catch (e) {
        console.error('Error refreshing tasks:', e);
      }
    }

    async function refreshReports() {
      try {
        const res = await fetch(`${API_BASE}/api/reports`);
        reports = await res.json();
        updateReportsList();
      } catch (e) {
        console.error('Error refreshing reports:', e);
      }
    }

    function updateStats() {
      document.getElementById('statActiveSessions').textContent = stats.activeSessions || 0;
      document.getElementById('statRunningTasks').textContent = stats.activeTasks || 0;
      document.getElementById('statCompleted').textContent = stats.completedTasks || 0;
      document.getElementById('statReports').textContent = stats.totalReports || 0;
    }

    function updateAgentsList() {
      const container = document.getElementById('agentsList');
      
      if (sessions.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-8">ç›®å‰æ²’æœ‰ä½œç”¨ä¸­çš„ Agents</p>';
        return;
      }
      
      container.innerHTML = sessions.slice(0, 10).map(session => {
        const active = session.isActive;
        return `
        <div class="flex items-center justify-between p-3 bg-white/5 rounded-lg hover:bg-white/10 transition">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 ${active ? 'bg-green-500/20' : 'bg-gray-500/20'} rounded-lg flex items-center justify-center">
              ${session.agent === 'coding-agent' ? 'ğŸ’»' : (active ? 'âš¡' : 'ğŸ’¤')}
            </div>
            <div>
              <p class="font-medium">${session.agent === 'coding-agent' ? 'ğŸ”§ ' : ''}${session.name || 'æœªå‘½å'}</p>
              <p class="text-xs text-gray-400">${session.agent || session.model || 'unknown'} â€¢ ${session.messages || 0} å‰‡è¨Šæ¯ â€¢ ${formatTimeAgo(session.updatedAt)}</p>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <span class="px-2 py-1 text-xs rounded-full ${getStatusClass(active ? 'active' : 'idle')}">${getStatusText(active ? 'active' : 'idle')}</span>
            <button onclick="viewSession('${session.id}')" class="text-blue-400 hover:text-blue-300 text-sm">æŸ¥çœ‹</button>
          </div>
        </div>
      `}).join('');
    }

    function getStatusClass(status) {
      const classes = {
        'active': 'bg-green-500/20 text-green-400',
        'processing': 'bg-yellow-500/20 text-yellow-400',
        'completed': 'bg-blue-500/20 text-blue-400',
        'idle': 'bg-gray-500/20 text-gray-400'
      };
      return classes[status] || classes.idle;
    }

    function getStatusText(status) {
      const texts = {
        'active': 'ä½œç”¨ä¸­',
        'processing': 'è™•ç†ä¸­',
        'completed': 'å·²å®Œæˆ',
        'idle': 'é–’ç½®'
      };
      return texts[status] || status;
    }

    function updateTaskQueue() {
      const container = document.getElementById('taskQueue');
      const activeTasks = tasks.filter(t => t.status === 'running' || t.status === 'processing');
      
      if (activeTasks.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-8">ç›®å‰æ²’æœ‰å¾…è™•ç†çš„ä»»å‹™</p>';
        return;
      }
      
      container.innerHTML = activeTasks.map(task => `
        <div class="p-3 bg-white/5 rounded-lg">
          <div class="flex items-center justify-between mb-2">
            <span class="font-medium text-sm">${task.task || 'æœªå‘½åä»»å‹™'}</span>
            <span class="text-xs text-yellow-400">${getStatusText(task.status)}</span>
          </div>
          <div class="w-full bg-white/10 rounded-full h-1.5">
            <div class="bg-yellow-500 h-1.5 rounded-full" style="width: ${task.progress || 50}%"></div>
          </div>
        </div>
      `).join('');
    }

    function updateReportsList() {
      const container = document.getElementById('reportsList');
      
      if (reports.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-8">ç›®å‰æ²’æœ‰å®Œæˆå ±å‘Š</p>';
        return;
      }
      
      container.innerHTML = reports.map(report => `
        <div class="p-4 bg-white/5 rounded-lg">
          <div class="flex items-start justify-between mb-3">
            <div>
              <h4 class="font-semibold">${report.title || 'ä»»å‹™å ±å‘Š'}</h4>
              <p class="text-xs text-gray-400">${formatDate(report.createdAt)}</p>
            </div>
            <span class="px-2 py-1 text-xs rounded-full ${report.status === 'success' ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}">
              ${report.status === 'success' ? 'æˆåŠŸ' : 'å¤±æ•—'}
            </span>
          </div>
          <div class="text-sm text-gray-300 mb-3">${report.summary || 'ç„¡æ‘˜è¦è³‡è¨Š'}</div>
          ${report.details ? `
            <details class="text-sm">
              <summary class="cursor-pointer text-blue-400 hover:text-blue-300">æŸ¥çœ‹è©³ç´°è³‡è¨Š</summary>
              <pre class="mt-2 p-3 bg-black/30 rounded-lg overflow-x-auto text-xs">${JSON.stringify(report.details, null, 2)}</pre>
            </details>
          ` : ''}
        </div>
      `).join('');
    }

    function formatDate(timestamp) {
      if (!timestamp) return 'æœªçŸ¥';
      return new Date(timestamp).toLocaleString('zh-TW');
    }

    function formatTimeAgo(timestamp) {
      if (!timestamp) return '';
      const seconds = Math.floor((Date.now() - timestamp) / 1000);
      if (seconds < 60) return 'å‰›å‰›';
      if (seconds < 3600) return `${Math.floor(seconds / 60)}åˆ†é˜å‰`;
      if (seconds < 86400) return `${Math.floor(seconds / 3600)}å°æ™‚å‰`;
      return `${Math.floor(seconds / 86400)}å¤©å‰`;
    }

    // Modal functions
    function openAgentTeamModal() {
      document.getElementById('agentTeamModal').classList.remove('hidden');
      document.getElementById('agentTeamModal').classList.add('flex');
    }

    function closeAgentTeamModal() {
      document.getElementById('agentTeamModal').classList.add('hidden');
      document.getElementById('agentTeamModal').classList.remove('flex');
    }

    async function submitAgentTeam() {
      const task = document.getElementById('taskDescription').value;
      const agents = Array.from(document.querySelectorAll('#agentSelection input:checked')).map(cb => cb.value);
      
      if (!task.trim()) {
        alert('è«‹è¼¸å…¥ä»»å‹™æè¿°');
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/api/agent-team`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ task, agents, workflow: ['analyze', 'implement', 'test', 'report'] })
        });
        
        const result = await res.json();
        console.log('Agent åœ˜éšŠå·²å»ºç«‹:', result);
        
        closeAgentTeamModal();
        refreshTasks();
      } catch (e) {
        alert('å»ºç«‹ Agent åœ˜éšŠæ™‚ç™¼ç”ŸéŒ¯èª¤: ' + e.message);
      }
    }

    function viewSession(id) {
      window.open(`${API_BASE}/api/sessions/${id}`, '_blank');
    }

    // Initialize
    connectWebSocket();
    refreshData();
    refreshTasks();
    refreshReports();

    // Auto-refresh every 10 seconds
    setInterval(() => {
      refreshData();
      refreshTasks();
    }, 10000);
  </script>
</body>
</html>
